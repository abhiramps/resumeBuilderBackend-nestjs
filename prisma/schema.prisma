// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  fullName  String? @map("full_name")
  avatarUrl String? @map("avatar_url")

  // Subscription info
  subscriptionTier      String    @default("free") @map("subscription_tier")
  subscriptionStatus    String    @default("active") @map("subscription_status")
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  trialEndsAt           DateTime? @map("trial_ends_at")
  stripeCustomerId      String?   @unique @map("stripe_customer_id")

  // Usage tracking
  resumeCount      Int    @default(0) @map("resume_count")
  exportCount      Int    @default(0) @map("export_count")
  storageUsedBytes BigInt @default(0) @map("storage_used_bytes")

  // Preferences
  preferences Json @default("{}")

  // Metadata
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")
  isActive    Boolean   @default(true) @map("is_active")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  resumes       Resume[]
  subscriptions Subscription[]
  payments      Payment[]

  @@map("users")
}

model Resume {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // Resume metadata
  title       String
  description String?
  templateId  String  @map("template_id")

  // Resume content (JSONB)
  content Json

  // Version control
  version          Int     @default(1)
  isCurrentVersion Boolean @default(true) @map("is_current_version")
  parentVersionId  String? @map("parent_version_id")

  // Status
  status     String  @default("draft")
  isPublic   Boolean @default(false) @map("is_public")
  publicSlug String? @unique @map("public_slug")

  // ATS metrics
  atsScore       Int?      @map("ats_score")
  atsIssues      Json      @default("[]") @map("ats_issues")
  lastAtsCheckAt DateTime? @map("last_ats_check_at")

  // Analytics
  viewCount      Int       @default(0) @map("view_count")
  exportCount    Int       @default(0) @map("export_count")
  lastExportedAt DateTime? @map("last_exported_at")

  // Metadata
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions ResumeVersion[]

  @@index([userId])
  @@index([templateId])
  @@index([status])
  @@index([publicSlug])
  @@index([userId, deletedAt])
  @@index([userId, updatedAt])
  @@index([userId, status, deletedAt])
  @@map("resumes")
}

model ResumeVersion {
  id       String @id @default(uuid())
  resumeId String @map("resume_id")
  userId   String @map("user_id")

  // Version info
  versionNumber Int     @map("version_number")
  versionName   String? @map("version_name")

  // Snapshot
  content    Json
  templateId String @map("template_id")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")

  // Change tracking
  changesSummary String? @map("changes_summary")
  diff           Json?

  // Relations
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@unique([resumeId, versionNumber])
  @@index([resumeId])
  @@index([userId])
  @@map("resume_versions")
}

model Subscription {
  id     String @id @default(uuid())
  userId String @map("user_id")
  planId String @map("plan_id")

  // Subscription details
  status       String  @default("active")
  billingCycle String? @map("billing_cycle")

  // Dates
  startedAt          DateTime  @default(now()) @map("started_at")
  currentPeriodStart DateTime  @map("current_period_start")
  currentPeriodEnd   DateTime  @map("current_period_end")
  cancelledAt        DateTime? @map("cancelled_at")
  trialStart         DateTime? @map("trial_start")
  trialEnd           DateTime? @map("trial_end")

  // Stripe integration
  stripeSubscriptionId String? @unique @map("stripe_subscription_id")
  stripeCustomerId     String? @map("stripe_customer_id")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([userId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model Payment {
  id             String  @id @default(uuid())
  userId         String  @map("user_id")
  subscriptionId String? @map("subscription_id")

  // Payment details
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("USD")
  status   String

  // Payment method
  paymentMethod     String? @map("payment_method")
  paymentProviderId String? @map("payment_provider_id")

  // Stripe integration
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id")
  stripeChargeId        String? @map("stripe_charge_id")

  // Metadata
  description String?
  metadata    Json    @default("{}")

  // Dates
  paidAt     DateTime? @map("paid_at")
  refundedAt DateTime? @map("refunded_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@map("payments")
}
